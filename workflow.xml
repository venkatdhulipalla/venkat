<workflow-app name="${workflowName}" xmlns="uri:oozie:workflow:0.5"
              xmlns:sla="uri:oozie:sla:0.2"> <!-- SLA specific tag and uri:oozie:workflow must be 0.5 -->
    <start to="wfm-spark-submit"/>

	<action name="qualityCheck">
        <ssh xmlns="uri:oozie:ssh-action:0.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="uri:oozie:ssh-action:0.2 ">
            <host>${applicationUserName}@${hostName}</host>
            <command>${qualityCheckSparkSubmitScript}</command>
            <arg>${appName}</arg>
            <arg>${qualityCheckClassName}</arg>
            <arg>${master}</arg>
            <arg>${deployMode}</arg>
            <arg>${queueName}</arg>
            <arg>${qualityCheckConfigFile}</arg>
            <arg>${qualityCheckJarLocation}</arg>
            <arg>${loggingScript}</arg>
            <arg>${localLogPath}</arg>
            <arg>${jobRunDate}</arg>
            <capture-output/>
        </ssh>
        <ok to="wfm-spark-submit"/>
        <error to="sendEmail"/>
    </action>

    <action name="sendEmail">
        <ssh xmlns="uri:oozie:ssh-action:0.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="uri:oozie:ssh-action:0.2 ">
            <host>${applicationUserName}@${hostName}</host>
            <command>${sendMailScript}</command>
            <arg>${mailFrom}</arg>
            <arg>${mailTo}</arg>
            <arg>${workflowName}</arg>
            <arg>${environment}</arg>
            <arg>${wf:actionData('qualityCheck')['ErrorLogFile']}</arg>
            <arg>Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</arg>
        </ssh>
        <ok to="kill"/>
        <error to="kill"/>
    </action>


    <kill name="kill">
        <message>Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
    </kill>
    <end name="end"/>

    <action name="wfm-spark-submit">
        <ssh xmlns="uri:oozie:ssh-action:0.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="uri:oozie:ssh-action:0.2 ">
            <host>${applicationUserName}@${hostName}</host>
            <command>${sshWfmProcessSparkSubmit}</command>
            <arg>${jobRunDate}</arg>
            <arg>${nameNode}</arg>
            <arg>${metricsName}</arg>
            <arg>${processclassName}</arg>
            <arg>${jarLocation}</arg>
            <arg>${queueName}</arg>
            <arg>${sourceJDBCURL}</arg>
            <arg>${applicationUserName}</arg>
            <arg>${hiveDBName}</arg>
            <arg>${hiveTableName}</arg>
            <arg>${noDays}</arg>
            <arg>${phoenixJdbcURL}</arg>
            <arg>${feedStartDate}</arg>
            <arg>${feedEndDate}</arg>
            <arg>${appName}</arg>
            <arg>${loggingScript}</arg>
            <arg>${localLogPath}</arg>
            <arg>${numExec}</arg>
            <arg>${memExec}</arg>
            <arg>${master}</arg>
            <arg>${deployMode}</arg>
            <arg>${numExecCores}</arg>
            <arg>${memDriver}</arg>
            <arg>${memMaxDriver}</arg>
            <arg>${kryoserializerBufferMax}</arg>
            <arg>${partitionColName}</arg>
            <arg>${dateColName}</arg>
            <arg>${hiveStagedDBName}</arg>
            <arg>${hiveStagedTableName}</arg>
            <arg>${stageTableDataLocation}</arg>
            <arg>${tableDataLocation}</arg>
            <arg>${zooKeeperURL}</arg>
            <arg>${zookeeperParent}</arg>
            <arg>${hbaseTableName}</arg>
            <arg>${hbaseDBName}</arg>
        </ssh>
        <ok to="decision-to-phoenix"/>
        <error to="kill"/>
    </action>

    <decision name="decision-to-phoenix">
        <switch>
            <case to="call-phoenix-dml">${hbaseFlag eq "Yes"}</case>
            <default to="decision-to-distcp"/>
        </switch>
    </decision>

    <action name="call-phoenix-dml">
        <ssh xmlns="uri:oozie:ssh-action:0.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="uri:oozie:ssh-action:0.2 ">
            <host>${applicationUserName}@${hostName}</host>
            <command>${sshPhoenixDmlCall}</command>
            <arg>${appName}</arg>
            <arg>${loggingScript}</arg>
            <arg>${localLogPath}</arg>
            <arg>${hbaseDBName}</arg>
            <arg>${hbaseTableName}</arg>
            <arg>${phoenixDBName}</arg>
            <arg>${phoenixTableName}</arg>
            <arg>${hiveDBName}</arg>
            <arg>${hiveTableName}</arg>
            <arg>${phoenixDmlLocation}</arg>
            <arg>${phoenixDmlFileName}</arg>
            <arg>${phoenixJarLocation}</arg>
            <arg>${sourceJDBCURL}</arg>
            <arg>${applicationUserName}</arg>
            <arg>${phoenixJdbcURL}</arg>
            <arg>${zookeeperParent}</arg>
            <arg>${jobRunDate}</arg>
        </ssh>
        <ok to="wfm-pheonix-delete"/>
        <error to="kill"/>
    </action>

    <action name="wfm-pheonix-delete">
        <ssh xmlns="uri:oozie:ssh-action:0.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="uri:oozie:ssh-action:0.2 ">
            <host>${applicationUserName}@${hostName}</host>
            <command>${sshWfmProcessSparkSubmit}</command>
            <arg>${jobRunDate}</arg>
            <arg>${nameNode}</arg>
            <arg>${metricsName}</arg>
            <arg>${phnxclassName}</arg>
            <arg>${jarLocation}</arg>
            <arg>${queueName}</arg>
            <arg>${sourceJDBCURL}</arg>
            <arg>${applicationUserName}</arg>
            <arg>${hiveDBName}</arg>
            <arg>${hiveTableName}</arg>
            <arg>${noDays}</arg>
            <arg>${phoenixJdbcURL}</arg>
            <arg>${feedStartDate}</arg>
            <arg>${feedEndDate}</arg>
            <arg>${appName}</arg>
            <arg>${loggingScript}</arg>
            <arg>${localLogPath}</arg>
            <arg>${numExec}</arg>
            <arg>${memExec}</arg>
            <arg>${master}</arg>
            <arg>${deployMode}</arg>
            <arg>${numExecCores}</arg>
            <arg>${memDriver}</arg>
            <arg>${memMaxDriver}</arg>
            <arg>${kryoserializerBufferMax}</arg>
            <arg>${partitionColName}</arg>
            <arg>${dateColName}</arg>
            <arg>${hiveStagedDBName}</arg>
            <arg>${hiveStagedTableName}</arg>
            <arg>${stageTableDataLocation}</arg>
            <arg>${tableDataLocation}</arg>
            <arg>${zooKeeperURL}</arg>
            <arg>${zookeeperParent}</arg>
            <arg>${hbaseTableName}</arg>
            <arg>${hbaseDBName}</arg>
        </ssh>
        <ok to="decision-to-distcp"/>
        <error to="kill"/>
    </action>


    <decision name="decision-to-distcp">
        <switch>
            <case to="cleanup">${fs:exists('/edx/us/lowes/replication_trigger/wfm_process_optimization/process/do_not_replicate')}/${hiveTableName}</case>
            <default to="distcp-type"/>
        </switch>
    </decision>


    <decision name="distcp-type">
        <switch>
            <case to="secured-distcp-node">${securedFlag eq "Yes"}</case>
            <default to="partition-distcp-node"/>
        </switch>
    </decision>


    <action name="secured-distcp-node">
        <distcp xmlns="uri:oozie:distcp-action:0.1">
            <job-tracker>${jobTracker}</job-tracker>
            <name-node>${nameNode}</name-node>
            <configuration>
                <property>
                    <name>mapred.job.queue.name</name>
                    <value>${queueName}</value>
                </property>
            </configuration>
            <arg>-delete</arg>
            <arg>-update</arg>
            <arg>-skipcrccheck</arg>
            <arg>${nameNode}${tableDataLocation}</arg>
            <arg>${targetNameNode}${tableDataLocation}</arg>
        </distcp>

        <ok to="add-partition-on-replicated-table"/>
        <error to="kill"/>
    </action>

    <action name="partition-distcp-node">
        <distcp xmlns="uri:oozie:distcp-action:0.1">
            <job-tracker>${jobTracker}</job-tracker>
            <name-node>${nameNode}</name-node>
            <configuration>
                <property>
                    <name>mapred.job.queue.name</name>
                    <value>${queueName}</value>
                </property>
            </configuration>
            <arg>-delete</arg>
            <arg>-overwrite</arg>
            <arg>${nameNode}${tableDataLocation}</arg>
            <arg>${targetNameNode}${tableDataLocation}</arg>
        </distcp>
        <ok to="add-partition-on-replicated-table"/>
        <error to="kill"/>
    </action>

    <action name="add-partition-on-replicated-table">
        <ssh xmlns="uri:oozie:ssh-action:0.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="uri:oozie:ssh-action:0.2 ">
            <host>${applicationUserName}@${hostName}</host>
            <command>${addPartitionsScript}</command>
            <arg>${applicationUserName}</arg>
            <arg>${targetHostName}</arg>
            <arg>${hiveDBName}</arg>
            <arg>${hiveTableName}</arg>
            <arg>${targetJDBCURL}</arg>
            <arg>${partitionColName}</arg>
            <arg>${localLogPath}</arg>
            <arg>${loggingScript}</arg>
            <arg>${load_dt}</arg>
            <!--  <arg>${tableType}</arg> -->
            <arg>${environment}</arg>
        </ssh>
        <ok to="cleanup"/>
        <error to="kill"/>
    </action>

    <action name="cleanup">
        <ssh xmlns="uri:oozie:ssh-action:0.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="uri:oozie:ssh-action:0.2 ">
            <host>${applicationUserName}@${hostName}</host>
            <command>${sshCleanup}</command>
            <arg>${nameNode}</arg>
            <arg>${localLogPath}</arg>
            <arg>${logRetentionDuration}</arg>
            <arg>${loggingScript}</arg>
            <arg>${hiveTableName}</arg>
            <arg>${load_dt}</arg>
        </ssh>
        <ok to="end"/>
        <error to="kill"/>
    </action>

    <kill name="kill">
        <message>Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
    </kill>

    <end name="end"/>


    <!-- SLA specific tags -->
    <sla:info>
        <sla:nominal-time>${nominalTime}</sla:nominal-time>
        <sla:should-start>${slaStart}</sla:should-start>
        <sla:should-end>${slaEnd}</sla:should-end>
        <sla:max-duration>${slaMaxDuration}</sla:max-duration>
        <sla:alert-events>${slaAlertEvents}</sla:alert-events>
        <sla:alert-contact>${slaAlertEmailIDs}</sla:alert-contact>
        <sla:notification-msg>${notificationMsg}</sla:notification-msg>
    </sla:info>


</workflow-app>
